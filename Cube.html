<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cube Chase Waves</title>
    <style>
        body {
            background: #000;
            margin: 0;
            overflow: hidden;
        }
        h1, #wave3Title, #wave4Title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-family: Arial, Helvetica, sans-serif;
            z-index: 2;
            text-shadow: 0 0 10px #f00, 0 0 20px #fff;
            pointer-events: none;
        }
        h1 { top: 30px; font-size: 48px; }
        #wave3Title, #wave4Title { top: 30px; font-size: 64px; display: none; }
        #timer {
            position: absolute;
            top: 30px;
            right: 40px;
            color: #fff;
            font-size: 48px;
            font-family: Arial, Helvetica, sans-serif;
            z-index: 2;
            text-shadow: 0 0 10px #f00, 0 0 20px #fff;
        }
        #restartBtn {
            display: none;
            position: absolute;
            left: 50%;
            top: 55%;
            transform: translate(-50%, -50%);
            padding: 18px 48px;
            font-size: 28px;
            background: #fff;
            color: #f00;
            border: 3px solid #f00;
            border-radius: 12px;
            cursor: pointer;
            z-index: 10;
            font-family: Arial, Helvetica, sans-serif;
            box-shadow: 0 0 20px #f00, 0 0 10px #fff;
        }
        #upgradeContainer {
            display: none;
            position: absolute;
            left: 50%;
            top: 60%;
            transform: translate(-50%, -50%);
            background: #222;
            border: 3px solid #fff;
            border-radius: 16px;
            padding: 32px 24px;
            z-index: 20;
            text-align: center;
        }
        .upgrade-btn {
            margin: 16px;
            padding: 18px 36px;
            font-size: 22px;
            border-radius: 10px;
            border: 2px solid #fff;
            background: #111;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .upgrade-btn:hover {
            background: #fff;
            color: #111;
        }
        #livesDisplay {
            position: absolute;
            left: 40px;
            top: 30px;
            color: #fff;
            font-size: 36px;
            font-family: Arial, Helvetica, sans-serif;
            z-index: 2;
            text-shadow: 0 0 10px #f00, 0 0 20px #fff;
        }
        #e-ui {
            display: none;
            position: absolute;
            width: 32px;
            height: 32px;
            background: rgba(255,255,255,0.85);
            color: #f00;
            font-size: 28px;
            font-family: Arial, Helvetica, sans-serif;
            font-weight: bold;
            border-radius: 50%;
            border: 2px solid #f00;
            text-align: center;
            line-height: 32px;
            z-index: 5;
            pointer-events: none;
            box-shadow: 0 0 8px #f00;
        }
        #bossHealthBar {
            display: none;
            position: absolute;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            color: #fff;
            font-size: 32px;
            font-family: Arial, Helvetica, sans-serif;
            background: #222;
            border: 2px solid #fff;
            border-radius: 10px;
            padding: 10px 40px;
            z-index: 100;
            text-align: center;
            box-shadow: 0 0 20px #0f0;
        }
        #playerHealthBar {
            display: none;
            position: absolute;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            background: #222;
            border: 3px solid #fff;
            border-radius: 15px;
            padding: 15px 50px;
            z-index: 100;
            text-align: center;
            box-shadow: 0 0 25px #00ff00;
        }
        #playerHealthBar .health-label {
            color: #fff;
            font-size: 20px;
            font-family: Arial, Helvetica, sans-serif;
            margin-bottom: 8px;
        }
        #playerHealthBar .health-bar-container {
            width: 400px;
            height: 30px;
            background: #333;
            border: 2px solid #666;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        #playerHealthBar .health-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #7fff00);
            transition: width 0.3s, background 0.3s;
            box-shadow: 0 0 15px #00ff00;
        }
        #playerHealthBar .health-bar-fill.low {
            background: linear-gradient(90deg, #ff0000, #ff6600);
            box-shadow: 0 0 15px #ff0000;
        }
        #playerHealthBar .health-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            font-family: Arial, Helvetica, sans-serif;
            text-shadow: 1px 1px 2px #000;
        }
        #loginScreen {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: #111;
            border: 3px solid #fff;
            border-radius: 20px;
            padding: 40px 60px;
            z-index: 1000;
            text-align: center;
            box-shadow: 0 0 30px #f00;
        }
        #loginScreen h1 {
            position: static;
            transform: none;
            margin-bottom: 30px;
            font-size: 48px;
        }
        .login-input {
            display: block;
            width: 300px;
            margin: 20px auto;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #fff;
            border-radius: 8px;
            background: #222;
            color: #fff;
            font-family: Arial, Helvetica, sans-serif;
        }
        .login-input:focus {
            outline: none;
            border-color: #f00;
            box-shadow: 0 0 10px #f00;
        }
        #startGameBtn {
            margin-top: 30px;
            padding: 18px 48px;
            font-size: 24px;
            background: #f00;
            color: #fff;
            border: 3px solid #fff;
            border-radius: 12px;
            cursor: pointer;
            font-family: Arial, Helvetica, sans-serif;
            box-shadow: 0 0 20px #f00;
            transition: all 0.3s;
        }
        #startGameBtn:hover {
            background: #fff;
            color: #f00;
            transform: scale(1.05);
        }
        #playerName {
            position: absolute;
            left: 40px;
            bottom: 30px;
            color: #fff;
            font-size: 28px;
            font-family: Arial, Helvetica, sans-serif;
            z-index: 2;
            text-shadow: 0 0 10px #0ff, 0 0 20px #fff;
            display: none;
        }
        #cheatPanel {
            display: none;
            position: absolute;
            right: 40px;
            top: 100px;
            background: rgba(0, 0, 0, 0.95);
            border: 3px solid #0f0;
            border-radius: 15px;
            padding: 20px;
            z-index: 500;
            min-width: 280px;
            box-shadow: 0 0 30px #0f0;
        }
        #cheatPanel h2 {
            color: #0f0;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 24px;
            margin: 0 0 15px 0;
            text-align: center;
            text-shadow: 0 0 10px #0f0;
        }
        .cheat-btn {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #0f0;
            border-radius: 8px;
            background: #001100;
            color: #0f0;
            cursor: pointer;
            font-family: Arial, Helvetica, sans-serif;
            transition: all 0.2s;
            text-align: left;
        }
        .cheat-btn:hover {
            background: #0f0;
            color: #000;
            box-shadow: 0 0 15px #0f0;
            transform: translateX(5px);
        }
        .cheat-btn:active {
            transform: translateX(5px) scale(0.98);
        }
        #toggleCheatPanel {
            display: none;
            position: absolute;
            right: 40px;
            top: 40px;
            padding: 10px 20px;
            font-size: 14px;
            background: rgba(0, 255, 0, 0.2);
            color: #0f0;
            border: 2px solid #0f0;
            border-radius: 8px;
            cursor: pointer;
            z-index: 501;
            font-family: Arial, Helvetica, sans-serif;
            box-shadow: 0 0 10px #0f0;
        }
        #toggleCheatPanel:hover {
            background: rgba(0, 255, 0, 0.4);
        }
        canvas {
            display: block;
        }
        
        /* Mobile Controls */
        #mobileControls {
            display: none;
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 50;
        }
        
        #mobileJoystick {
            position: absolute;
            left: 50px;
            bottom: 80px;
            width: 150px;
            height: 150px;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            pointer-events: all;
        }
        
        #joystickKnob {
            position: absolute;
            left: 50%;
            top: 50%;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.6);
            border: 3px solid #fff;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.8);
        }
        
        #mobileDashBtn {
            position: absolute;
            right: 50px;
            bottom: 80px;
            width: 100px;
            height: 100px;
            background: rgba(0, 255, 0, 0.3);
            border: 3px solid #0f0;
            border-radius: 50%;
            color: #0f0;
            font-size: 40px;
            font-family: Arial, Helvetica, sans-serif;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: all;
            box-shadow: 0 0 20px #0f0;
            user-select: none;
        }
        
        #mobileDashBtn:active {
            background: rgba(0, 255, 0, 0.6);
            transform: scale(0.95);
        }
        
        #mobileDashBtn.disabled {
            opacity: 0.3;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="loginScreen">
        <h1>Cube Chase Waves</h1>
        <input type="text" id="usernameInput" class="login-input" placeholder="Enter your name" maxlength="20">
        <input type="password" id="passwordInput" class="login-input" placeholder="Enter password" maxlength="20">
        <button id="startGameBtn" onclick="startGame()">Start Game</button>
    </div>
    <h1 id="waveTitle" style="display: none;">Wave One</h1>
    <div id="wave4Title">Wave 4</div>
    <div id="timer">30</div>
    <div id="livesDisplay"></div>
    <button id="restartBtn" onclick="restartGame()">Restart</button>
    <div id="upgradeContainer">
        <h2 style="color:#fff;" id="upgradeTitle">Choose an Upgrade!</h2>
        <div id="upgradeButtons"></div>
    </div>
    <div id="bossHealthBar">
        Boss Health: <span id="bossHealthValue">15</span>
    </div>
    <div id="playerHealthBar">
        <div class="health-label">Player Health</div>
        <div class="health-bar-container">
            <div class="health-bar-fill" id="healthBarFill"></div>
            <div class="health-text" id="healthBarText">100 / 100</div>
        </div>
    </div>
    <div id="e-ui">E</div>
    <div id="playerName"></div>
    <button id="toggleCheatPanel" onclick="toggleCheats()">🎮 Cheats</button>
    
    <!-- Mobile Controls -->
    <div id="mobileControls">
        <div id="mobileJoystick">
            <div id="joystickKnob"></div>
        </div>
        <div id="mobileDashBtn">E</div>
    </div>
    <div id="cheatPanel">
        <h2>⚡ ADMIN PANEL ⚡</h2>
        <button class="cheat-btn" onclick="cheat_speed()">⚡ +10% Speed Boost</button>
        <button class="cheat-btn" onclick="cheat_godMode()">🛡️ God Mode (Invincible)</button>
        <button class="cheat-btn" onclick="cheat_freezeGame()">❄️ Freeze Game (5s)</button>
        <button class="cheat-btn" onclick="cheat_skipWave()">⏭️ Skip Current Wave</button>
        <button class="cheat-btn" onclick="cheat_addLives()">❤️ +5 Extra Lives</button>
        <button class="cheat-btn" onclick="cheat_killAllEnemies()">💀 Kill All Enemies</button>
        <button class="cheat-btn" onclick="cheat_oneHitBoss()">💥 One-Hit Boss Kill</button>
        <button class="cheat-btn" onclick="cheat_slowMotion()">🐌 Slow Motion Toggle</button>
        <button class="cheat-btn" onclick="cheat_teleport()">🌀 Teleport to Center</button>
        <button class="cheat-btn" onclick="cheat_maxUpgrades()">🔥 Unlock All Upgrades</button>
    </div>
    <canvas id="gameCanvas"></canvas>
    <script>
        // --- Mobile Detection ---
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                         ('ontouchstart' in window) || 
                         (navigator.maxTouchPoints > 0);
        
        // --- Game State ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width = window.innerWidth;
        let height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;

        let wave = 1;
        let timeLeft = 30;
        let timerInterval = null;
        let gameOver = false;
        let lives = 1;
        let upgrades = { speed: false, dash: false, life: false };
        let furtherDash = false, moreSpeed = false;
        let dashCooldown = false;
        let cubeSize = 40;
        let whiteCube, redCubes = [];
        let laserPatterns = [], laserActive = false, laserTimeout = null, laserWarningTimeout = null;
        let laserPatternInterval = null;
        let eUI = document.getElementById('e-ui');
        let bossActive = false, boss = null, bossBullets = [], bossHealth = 15, bossPhase2 = false;
        let bossBulletInterval = null, bossLaserInterval = null, bossGreenCube = null, bossGreenCubeActive = false, bossGreenCubeTimeout = null;
        
        // Wave 6-10 mechanics
        let bulletRain = [], bulletRainInterval = null;
        let earthquakeActive = false, earthquakeZones = [], earthquakeInterval = null;
        let screenShake = { x: 0, y: 0 };
        let finalBossActive = false, finalBoss = null, finalBossHealth = 20;
        
        // Health system for waves 6-10
        let playerHealth = 100;
        let maxPlayerHealth = 100;
        let damageCooldown = false;
        let damageCooldownTime = 3000; // 3 seconds
        
        // Healing cubes for final boss
        let healingCubes = [];
        let healingCubeInterval = null;

        // Add boss movement direction and speed
        let bossMoveDir = 1; // 1 for right, -1 for left
        let bossMoveSpeed = 4;

        // Player credentials
        let playerUsername = "";
        let playerPassword = "";
        let gameStarted = false;
        let isAdmin = false;
        let godMode = false;
        let slowMotionActive = false;
        
        // Mobile controls state
        let mobileJoystick = { active: false, x: 0, y: 0, deltaX: 0, deltaY: 0 };
        let mobileDashReady = true;

        // --- Start Game Function ---
        function startGame() {
            let username = document.getElementById('usernameInput').value.trim();
            let password = document.getElementById('passwordInput').value.trim();
            
            if (username === "" || password === "") {
                alert("Please enter both name and password!");
                return;
            }
            
            playerUsername = username;
            playerPassword = password;
            gameStarted = true;
            
            // Check for admin credentials
            if (username === "Haster" && password === "Representative") {
                isAdmin = true;
                document.getElementById('toggleCheatPanel').style.display = "block";
                document.getElementById('cheatPanel').style.display = "block";
            }
            
            // Hide login screen
            document.getElementById('loginScreen').style.display = "none";
            
            // Show player name
            let nameDisplay = "Player: " + playerUsername;
            if (isAdmin) nameDisplay += " [ADMIN]";
            document.getElementById('playerName').textContent = nameDisplay;
            document.getElementById('playerName').style.display = "block";
            if (isAdmin) {
                document.getElementById('playerName').style.color = "#0f0";
                document.getElementById('playerName').style.textShadow = "0 0 10px #0f0, 0 0 20px #0f0";
            }
            
            // Show wave title
            document.getElementById('waveTitle').style.display = "block";
            
            // Initialize mobile controls if mobile device
            if (isMobile) {
                initMobileControls();
            }
            
            // Start the game
            setupGame();
            startTimer();
            animate();
        }

        // Allow Enter key to start game
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('usernameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('passwordInput').focus();
                }
            });
            document.getElementById('passwordInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    startGame();
                }
            });
        });

        // --- Cheat Functions ---
        function toggleCheats() {
            let panel = document.getElementById('cheatPanel');
            panel.style.display = (panel.style.display === 'none') ? 'block' : 'none';
        }

        function cheat_speed() {
            if (!isAdmin) return;
            whiteCube.speed *= 1.1;
            showCheatNotification("⚡ Speed increased by 10%!");
        }

        function cheat_godMode() {
            if (!isAdmin) return;
            godMode = !godMode;
            if (godMode) {
                showCheatNotification("🛡️ God Mode ENABLED! You are invincible!");
            } else {
                showCheatNotification("🛡️ God Mode DISABLED!");
            }
        }

        function cheat_freezeGame() {
            if (!isAdmin) return;
            gameOver = true;
            showCheatNotification("❄️ Game frozen for 5 seconds!");
            setTimeout(() => {
                gameOver = false;
                animate();
                showCheatNotification("❄️ Game unfrozen!");
            }, 5000);
        }

        function cheat_skipWave() {
            if (!isAdmin) return;
            if (wave < 10) {
                clearInterval(timerInterval);
                if (laserPatternInterval) clearInterval(laserPatternInterval);
                if (bulletRainInterval) clearInterval(bulletRainInterval);
                if (earthquakeInterval) clearInterval(earthquakeInterval);
                showCheatNotification("⏭️ Skipping to next wave!");
                nextWaveOrGameOver();
            } else {
                showCheatNotification("⏭️ Already at final wave!");
            }
        }

        function cheat_addLives() {
            if (!isAdmin) return;
            lives += 5;
            updateLivesDisplay();
            showCheatNotification("❤️ Added 5 lives!");
        }

        function cheat_killAllEnemies() {
            if (!isAdmin) return;
            redCubes = [];
            showCheatNotification("💀 All enemies eliminated!");
        }

        function cheat_oneHitBoss() {
            if (!isAdmin) return;
            if (wave === 4 && bossActive) {
                bossHealth = 1;
                document.getElementById('bossHealthValue').textContent = bossHealth;
                showCheatNotification("💥 Boss health set to 1!");
            } else if (wave === 10 && finalBossActive) {
                finalBossHealth = 1;
                document.getElementById('bossHealthValue').textContent = finalBossHealth;
                showCheatNotification("💥 Final boss health set to 1!");
            } else {
                showCheatNotification("💥 No boss active!");
            }
        }

        function cheat_slowMotion() {
            if (!isAdmin) return;
            slowMotionActive = !slowMotionActive;
            if (slowMotionActive) {
                showCheatNotification("🐌 Slow motion ENABLED!");
            } else {
                showCheatNotification("🐌 Slow motion DISABLED!");
            }
        }

        function cheat_teleport() {
            if (!isAdmin) return;
            whiteCube.x = width / 2 - cubeSize / 2;
            whiteCube.y = height / 2 - cubeSize / 2;
            showCheatNotification("🌀 Teleported to center!");
        }

        function cheat_maxUpgrades() {
            if (!isAdmin) return;
            upgrades.speed = 2.0;
            upgrades.dash = true;
            upgrades.life = true;
            lives += 10;
            whiteCube.speed = 12;
            updateLivesDisplay();
            showCheatNotification("🔥 All upgrades unlocked!");
        }

        function showCheatNotification(message) {
            let notification = document.createElement('div');
            notification.textContent = message;
            notification.style.position = 'absolute';
            notification.style.left = '50%';
            notification.style.top = '50%';
            notification.style.transform = 'translate(-50%, -50%)';
            notification.style.background = 'rgba(0, 255, 0, 0.9)';
            notification.style.color = '#000';
            notification.style.padding = '20px 40px';
            notification.style.borderRadius = '10px';
            notification.style.fontSize = '24px';
            notification.style.fontFamily = 'Arial, Helvetica, sans-serif';
            notification.style.fontWeight = 'bold';
            notification.style.zIndex = '1000';
            notification.style.boxShadow = '0 0 30px #0f0';
            notification.style.border = '3px solid #000';
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // --- Utility ---
        function randomEdgePosition() {
            let edge = Math.floor(Math.random() * 4);
            if (edge === 0) return {x: 0, y: Math.random() * height};
            if (edge === 1) return {x: width - cubeSize, y: Math.random() * height};
            if (edge === 2) return {x: Math.random() * width, y: 0};
            return {x: Math.random() * width, y: height - cubeSize};
        }

        // --- Setup ---
        function setupGame() {
            timeLeft = 30;
            document.getElementById('timer').textContent = timeLeft;
            gameOver = false;
            dashCooldown = false;
            cubeSize = (wave === 2) ? 60 : 40;
            // Calculate speed with upgrades
            let baseSpeed = 6;
            if (upgrades.speed) baseSpeed *= upgrades.speed;
            whiteCube = {
                x: width / 2 - cubeSize / 2,
                y: height / 2 - cubeSize / 2,
                color: "#fff",
                speed: baseSpeed,
                dx: 0,
                dy: 0
            };
            redCubes = [];
            let redCubeCount = (wave === 2) ? 6 : 3;
            let redCubeSize = (wave === 2) ? 60 : 40;
            // Only spawn red cubes in wave 1 and 2
            if (wave === 1 || wave === 2) {
                for (let i = 0; i < redCubeCount; i++) {
                    let pos = randomEdgePosition();
                    redCubes.push({
                        x: pos.x,
                        y: pos.y,
                        color: "#f00",
                        speed: (wave === 2 ? 4.5 : 3.5) + Math.random(),
                        size: redCubeSize
                    });
                }
            }
            document.getElementById('restartBtn').style.display = "none";
            document.getElementById('upgradeContainer').style.display = "none";
            document.getElementById('bossHealthBar').style.display = "none";
            if (wave >= 6 && wave <= 10) {
                document.getElementById('playerHealthBar').style.display = "none";
            }
            updateLivesDisplay();
            
            // Clear wave 6-10 mechanics
            bulletRain = [];
            earthquakeZones = [];
            earthquakeActive = false;
            screenShake = { x: 0, y: 0 };
            if (bulletRainInterval) clearInterval(bulletRainInterval);
            if (earthquakeInterval) clearInterval(earthquakeInterval);

            // Only show "Wave One" heading in wave 1
            if (wave === 1) {
                document.getElementById('waveTitle').style.display = "block";
                document.getElementById('waveTitle').textContent = "Wave One";
            } else {
                document.getElementById('waveTitle').style.display = "none";
            }
            // Hide other headings
            let wave2Title = document.getElementById('wave2Title');
            if (wave2Title) wave2Title.style.display = "none";
            document.getElementById('wave4Title').style.display = (wave === 4) ? "block" : "none";
            let waveErrorTitle = document.getElementById('waveErrorTitle');
            if (waveErrorTitle) waveErrorTitle.style.display = "none";

            laserPatterns = [];
            laserActive = false;
            if (laserTimeout) clearTimeout(laserTimeout);
            if (laserWarningTimeout) clearTimeout(laserWarningTimeout);
            if (laserPatternInterval) clearInterval(laserPatternInterval);
            if (bossBulletInterval) clearInterval(bossBulletInterval);
            if (bossLaserInterval) clearInterval(bossLaserInterval);
            if (bossGreenCubeTimeout) clearTimeout(bossGreenCubeTimeout);
        }

        // --- Timer ---
        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    nextWaveOrGameOver();
                }
            }, 1000);
        }

        // --- Movement Controls ---
        // Use a key state map for smoother and more responsive controls
        let keyState = {};

        document.addEventListener('keydown', e => {
            keyState[e.key.toLowerCase()] = true;

            // Dash ability with "e" key (trigger on keydown)
            if (upgrades.dash && !dashCooldown && (e.key === "e" || e.key === "E")) {
                performDash();
            }
        });

        document.addEventListener('keyup', e => {
            keyState[e.key.toLowerCase()] = false;
        });
        
        // Dash function
        function performDash() {
            if (!upgrades.dash || dashCooldown) return;
            
            dashCooldown = true;
            let dashX = 0, dashY = 0;
            
            if (isMobile) {
                // Use joystick direction for mobile
                dashX = mobileJoystick.deltaX;
                dashY = mobileJoystick.deltaY;
                if (dashX === 0 && dashY === 0) {
                    dashX = 1; // Default forward if no direction
                }
            } else {
                // Use keyboard for desktop
                if (keyState["arrowright"] || keyState["d"]) dashX = 1;
                else if (keyState["arrowleft"] || keyState["a"]) dashX = -1;
                if (keyState["arrowdown"] || keyState["s"]) dashY = 1;
                else if (keyState["arrowup"] || keyState["w"]) dashY = -1;
            }
            
            let dashDistance = 120;
            if ((wave === 3 && furtherDash) || (wave === 4 && (furtherDash || moreSpeed))) dashDistance = 220;
            whiteCube.x += dashX * dashDistance;
            whiteCube.y += dashY * dashDistance;
            if (whiteCube.x < 0) whiteCube.x = 0;
            if (whiteCube.x > width - cubeSize) whiteCube.x = width - cubeSize;
            if (whiteCube.y < 0) whiteCube.y = 0;
            if (whiteCube.y > height - cubeSize) whiteCube.y = height - cubeSize;
            
            // Update mobile dash button state
            if (isMobile) {
                mobileDashReady = false;
                document.getElementById('mobileDashBtn').classList.add('disabled');
            }
            
            setTimeout(() => { 
                dashCooldown = false;
                if (isMobile) {
                    mobileDashReady = true;
                    document.getElementById('mobileDashBtn').classList.remove('disabled');
                }
            }, 1200);
        }

        // Update moveWhiteCube to use keyState for instant response
        function moveWhiteCube() {
            let dx = 0, dy = 0;
            
            if (isMobile) {
                // Use joystick for mobile
                dx = mobileJoystick.deltaX * whiteCube.speed;
                dy = mobileJoystick.deltaY * whiteCube.speed;
            } else {
                // Use keyboard for desktop
                if (keyState["arrowup"] || keyState["w"]) dy -= whiteCube.speed;
                if (keyState["arrowdown"] || keyState["s"]) dy += whiteCube.speed;
                if (keyState["arrowleft"] || keyState["a"]) dx -= whiteCube.speed;
                if (keyState["arrowright"] || keyState["d"]) dx += whiteCube.speed;
            }
            
            whiteCube.x += dx;
            whiteCube.y += dy;
            if (whiteCube.x < 0) whiteCube.x = 0;
            if (whiteCube.x > width - cubeSize) whiteCube.x = width - cubeSize;
            if (whiteCube.y < 0) whiteCube.y = 0;
            if (whiteCube.y > height - cubeSize) whiteCube.y = height - cubeSize;
        }
        function moveRedCubes() {
            // Apply slow motion if active
            let speedMultiplier = (slowMotionActive && isAdmin) ? 0.3 : 1;
            for (let cube of redCubes) {
                let dx = whiteCube.x - cube.x;
                let dy = whiteCube.y - cube.y;
                let dist = Math.sqrt(dx * dx + dy * dy);
                if (dist > 0) {
                    cube.x += (dx / dist) * cube.speed * speedMultiplier;
                    cube.y += (dy / dist) * cube.speed * speedMultiplier;
                }
            }
        }
        function checkCollision() {
            for (let cube of redCubes) {
                if (
                    whiteCube.x < cube.x + cube.size &&
                    whiteCube.x + cubeSize > cube.x &&
                    whiteCube.y < cube.y + cube.size &&
                    whiteCube.y + cubeSize > cube.y
                ) {
                    return true;
                }
            }
            return false;
        }
        function updateLivesDisplay() {
            document.getElementById('livesDisplay').textContent = "Lives: " + lives;
        }
        
        // Health system functions
        function updateHealthBar() {
            let healthBarFill = document.getElementById('healthBarFill');
            let healthBarText = document.getElementById('healthBarText');
            let percentage = (playerHealth / maxPlayerHealth) * 100;
            
            healthBarFill.style.width = percentage + "%";
            healthBarText.textContent = playerHealth + " / " + maxPlayerHealth;
            
            if (percentage <= 30) {
                healthBarFill.classList.add('low');
            } else {
                healthBarFill.classList.remove('low');
            }
        }
        
        function takeDamage(amount) {
            if (godMode && isAdmin) {
                showCheatNotification("🛡️ God Mode protected you!");
                return false;
            }
            
            if (damageCooldown) return false;
            
            playerHealth -= amount;
            if (playerHealth < 0) playerHealth = 0;
            updateHealthBar();
            
            // Activate damage cooldown
            damageCooldown = true;
            setTimeout(() => {
                damageCooldown = false;
            }, damageCooldownTime);
            
            // Flash effect
            whiteCube.color = "#f00";
            setTimeout(() => {
                whiteCube.color = "#fff";
            }, 200);
            
            if (playerHealth <= 0) {
                return true; // Player died
            }
            return false;
        }

        // --- Draw Cube ---
        function drawCube(cube) {
            ctx.save();
            ctx.fillStyle = cube.color;
            ctx.shadowColor = cube.color;
            ctx.shadowBlur = 20;
            let size = cube.size || cubeSize;
            ctx.fillRect(cube.x, cube.y, size, size);
            ctx.restore();
        }

        // --- Lasers ---
        function spawnLaserPatterns() {
            // Boss phase 2: always spawn patterns
            if (wave === 4 && bossActive && bossPhase2) {
                laserPatterns = [];
                let patternCount = Math.floor(Math.random() * 3) + 3; // 3-5
                let patternTypes = ["vertical", "horizontal", "down"];
                for (let i = 0; i < patternCount; i++) {
                    let type = patternTypes[Math.floor(Math.random() * patternTypes.length)];
                    if (type === "vertical") {
                        let offsetX = (Math.random() - 0.5) * 200;
                        let targetX = whiteCube.x + cubeSize / 2 + offsetX;
                        targetX = Math.max(0, Math.min(width, targetX));
                        laserPatterns.push({
                            type: "vertical",
                            x1: targetX,
                            y1: 0,
                            x2: targetX,
                            y2: height
                        });
                    } else if (type === "horizontal") {
                        let offsetY = (Math.random() - 0.5) * 200;
                        let targetY = whiteCube.y + cubeSize / 2 + offsetY;
                        targetY = Math.max(0, Math.min(height, targetY));
                        laserPatterns.push({
                            type: "horizontal",
                            x1: 0,
                            y1: targetY,
                            x2: width,
                            y2: targetY
                        });
                    } else if (type === "down") {
                        let offset = (Math.random() - 0.5) * 200;
                        let startX = whiteCube.x + cubeSize / 2 + offset;
                        let startY = 0;
                        let endX = startX + height;
                        let endY = height;
                        laserPatterns.push({
                            type: "down",
                            x1: startX,
                            y1: startY,
                            x2: endX,
                            y2: endY
                        });
                    }
                }
                laserActive = false;
                setTimeout(() => {
                    laserActive = true;
                    laserTimeout = setTimeout(() => {
                        checkLaserHit();
                        laserActive = false;
                        laserPatterns = [];
                    }, 500);
                }, 500);
                return;
            }
            // Normal wave 2/3/6-10 logic
            if (wave < 2) return;
            laserPatterns = [];
            let patternCount = (wave === 3) ? Math.floor(Math.random() * 3) + 3 : 3;
            let patternTypes = (wave === 3 || wave >= 6) ? ["vertical", "horizontal", "down"] : ["vertical"];
            for (let i = 0; i < patternCount; i++) {
                let type = patternTypes[Math.floor(Math.random() * patternTypes.length)];
                if (type === "vertical") {
                    let offsetX = (Math.random() - 0.5) * 200;
                    let targetX = whiteCube.x + cubeSize / 2 + offsetX;
                    targetX = Math.max(0, Math.min(width, targetX));
                    laserPatterns.push({
                        type: "vertical",
                        x1: targetX,
                        y1: 0,
                        x2: targetX,
                        y2: height
                    });
                } else if (type === "horizontal") {
                    let offsetY = (Math.random() - 0.5) * 200;
                    let targetY = whiteCube.y + cubeSize / 2 + offsetY;
                    targetY = Math.max(0, Math.min(height, targetY));
                    laserPatterns.push({
                        type: "horizontal",
                        x1: 0,
                        y1: targetY,
                        x2: width,
                        y2: targetY
                    });
                } else if (type === "down") {
                    let offset = (Math.random() - 0.5) * 200;
                    let startX = whiteCube.x + cubeSize / 2 + offset;
                    let startY = 0;
                    let endX = startX + height;
                    let endY = height;
                    laserPatterns.push({
                        type: "down",
                        x1: startX,
                        y1: startY,
                        x2: endX,
                        y2: endY
                    });
                }
            }
            laserActive = false;
            setTimeout(() => {
                laserActive = true;
                laserTimeout = setTimeout(() => {
                    if (laserActive) checkLaserHit();
                    laserActive = false;
                    laserPatterns = [];
                }, 500);
            }, 1000);
        }
        function drawLaserPatterns() {
            if (laserPatterns.length === 0) return;
            for (let i = 0; i < laserPatterns.length; i++) {
                ctx.save();
                if (laserActive) {
                    ctx.strokeStyle = "#f00";
                    ctx.lineWidth = 10;
                    ctx.shadowColor = "#f00";
                    ctx.shadowBlur = 20;
                } else {
                    ctx.strokeStyle = "#ff0";
                    ctx.lineWidth = 4;
                    ctx.setLineDash([20, 20]);
                }
                ctx.beginPath();
                ctx.moveTo(laserPatterns[i].x1, laserPatterns[i].y1);
                ctx.lineTo(laserPatterns[i].x2, laserPatterns[i].y2);
                ctx.stroke();
                ctx.setLineDash([]);
                ctx.restore();
            }
        }
        function checkLaserHit() {
            for (let i = 0; i < laserPatterns.length; i++) {
                let pattern = laserPatterns[i];
                let hit = false;
                if (pattern.type === "vertical") {
                    let lx = pattern.x1;
                    if (whiteCube.x < lx && whiteCube.x + cubeSize > lx) {
                        hit = true;
                    }
                } else if (pattern.type === "horizontal") {
                    let ly = pattern.y1;
                    if (whiteCube.y < ly && whiteCube.y + cubeSize > ly) {
                        hit = true;
                    }
                } else if (pattern.type === "down") {
                    let relX = whiteCube.x + cubeSize / 2;
                    let relY = whiteCube.y + cubeSize / 2;
                    let b = pattern.y1 - pattern.x1;
                    let dist = Math.abs(relY - (relX + b));
                    if (dist < cubeSize) {
                        hit = true;
                    }
                }
                
                if (hit) {
                    if (wave >= 6 && wave <= 10) {
                        if (!damageCooldown && takeDamage(20)) {
                            loseLife();
                        }
                    } else {
                        loseLife();
                    }
                    return;
                }
            }
        }

        // --- Boss ---
        function startBossWave() {
            bossActive = true;
            bossHealth = 15;
            bossPhase2 = false;
            document.getElementById('bossHealthBar').style.display = "block";
            document.getElementById('bossHealthValue').textContent = bossHealth;
            document.getElementById('timer').textContent = "ERROR";
            // Stop the timer during boss fight
            if (timerInterval) clearInterval(timerInterval);
            boss = { x: width / 2 - 100, y: 80, size: 200, color: "#0ff" };
            bossBullets = [];
            bossGreenCube = null;
            bossGreenCubeActive = false;
            bossMoveDir = 1; // Reset direction
            bossBulletInterval = setInterval(() => { shootBossBullets(); }, 1200);
            bossGreenCubeTimeout = setTimeout(() => { spawnBossGreenCube(); }, 5000);

            // Remove "Wave 4" and "Wave 2" titles if present
            document.getElementById('wave4Title').style.display = "none";
            let wave2Title = document.getElementById('wave2Title');
            if (wave2Title) wave2Title.style.display = "none";

            // Add or show "Wave ERROR" at top center
            let waveErrorTitle = document.getElementById('waveErrorTitle');
            if (!waveErrorTitle) {
                waveErrorTitle = document.createElement("h1");
                waveErrorTitle.id = "waveErrorTitle";
                waveErrorTitle.style.position = "absolute";
                waveErrorTitle.style.top = "30px";
                waveErrorTitle.style.left = "50%";
                waveErrorTitle.style.transform = "translateX(-50%)";
                waveErrorTitle.style.color = "#fff";
                waveErrorTitle.style.fontSize = "48px";
                waveErrorTitle.style.fontFamily = "Arial, Helvetica, sans-serif";
                waveErrorTitle.style.zIndex = "2";
                waveErrorTitle.style.textShadow = "0 0 10px #f00, 0 0 20px #fff";
                waveErrorTitle.style.pointerEvents = "none";
                waveErrorTitle.textContent = "Wave ERROR";
                document.body.appendChild(waveErrorTitle);
            } else {
                waveErrorTitle.style.display = "block";
            }
        }
        function shootBossBullets() {
            if (!bossActive) return;
            let angles = [];
            if (!bossPhase2) {
                angles = [
                    0, Math.PI/4, Math.PI/2, 3*Math.PI/4, Math.PI, 5*Math.PI/4, 3*Math.PI/2, 7*Math.PI/4,
                    Math.atan2(1,2), Math.atan2(-1,2)
                ];
            } else {
                for (let i = 0; i < 16; i++) {
                    angles.push((2 * Math.PI / 16) * i);
                }
            }
            let centerX = boss.x + boss.size / 2;
            let centerY = boss.y + boss.size / 2;
            for (let i = 0; i < angles.length; i++) {
                let angle = angles[i];
                bossBullets.push({
                    x: centerX,
                    y: centerY,
                    size: 18,
                    color: "#f0f",
                    dx: Math.cos(angle) * 7,
                    dy: Math.sin(angle) * 7
                });
            }
        }
        function spawnBossGreenCube() {
            if (!bossActive) return;
            let edge = Math.floor(Math.random() * 4);
            let x, y;
            let size = 40;
            if (edge === 0) { x = 0; y = Math.random() * (height - size); }
            else if (edge === 1) { x = width - size; y = Math.random() * (height - size); }
            else if (edge === 2) { x = Math.random() * (width - size); y = 0; }
            else { x = Math.random() * (width - size); y = height - size; }
            bossGreenCube = { x, y, size, color: "#0f0" };
            bossGreenCubeActive = true;
        }
        function drawBoss() {
            if (!bossActive || !boss) return;
            ctx.save();
            ctx.fillStyle = boss.color;
            ctx.shadowColor = "#0ff";
            ctx.shadowBlur = 30;
            ctx.fillRect(boss.x, boss.y, boss.size, boss.size);
            ctx.restore();
        }
        function drawBossBullets() {
            for (let i = 0; i < bossBullets.length; i++) {
                let b = bossBullets[i];
                ctx.save();
                ctx.fillStyle = b.color;
                ctx.shadowColor = "#f0f";
                ctx.shadowBlur = 10;
                ctx.fillRect(b.x, b.y, b.size, b.size);
                ctx.restore();
            }
        }
        function moveBossBullets() {
            // Apply slow motion if active
            let speedMultiplier = (slowMotionActive && isAdmin) ? 0.3 : 1;
            for (let i = 0; i < bossBullets.length; i++) {
                bossBullets[i].x += bossBullets[i].dx * speedMultiplier;
                bossBullets[i].y += bossBullets[i].dy * speedMultiplier;
            }
            bossBullets = bossBullets.filter(b =>
                b.x + b.size > 0 && b.x < width && b.y + b.size > 0 && b.y < height
            );
        }
        function drawBossGreenCube() {
            if (bossGreenCubeActive && bossGreenCube) {
                ctx.save();
                ctx.fillStyle = bossGreenCube.color;
                ctx.shadowColor = "#0f0";
                ctx.shadowBlur = 20;
                ctx.fillRect(bossGreenCube.x, bossGreenCube.y, bossGreenCube.size, bossGreenCube.size);
                ctx.restore();
            }
        }
        function checkBossGreenCubeCollision() {
            if (!bossGreenCubeActive || !bossGreenCube) return;
            if (
                whiteCube.x < bossGreenCube.x + bossGreenCube.size &&
                whiteCube.x + cubeSize > bossGreenCube.x &&
                whiteCube.y < bossGreenCube.y + bossGreenCube.size &&
                whiteCube.y + cubeSize > bossGreenCube.y
            ) {
                let damage = (bossHealth < 10) ? 2 : 1;
                bossHealth -= damage;
                if (bossHealth < 0) bossHealth = 0;
                document.getElementById('bossHealthValue').textContent = bossHealth;
                bossGreenCubeActive = false;
                bossGreenCube = null;
                if (bossHealth > 0) {
                    bossGreenCubeTimeout = setTimeout(() => { spawnBossGreenCube(); }, 5000);
                }
                if (bossHealth < 10 && !bossPhase2) {
                    bossPhase2 = true;
                    if (bossLaserInterval) clearInterval(bossLaserInterval);
                    bossLaserInterval = setInterval(spawnLaserPatterns, 1200);
                }
                if (bossHealth <= 0) {
                    bossActive = false;
                    gameOver = true;
                    document.getElementById('bossHealthBar').style.display = "none";
                    document.getElementById('livesDisplay').style.display = "none"; // Hide lives after first boss
                    document.getElementById('timer').textContent = "Wave 5 Complete!";
                    clearInterval(bossBulletInterval);
                    if (bossLaserInterval) clearInterval(bossLaserInterval);
                    if (bossGreenCubeTimeout) clearTimeout(bossGreenCubeTimeout);
                    // Continue to wave 6
                    setTimeout(() => {
                        wave = 6;
                        playerHealth = 100;
                        maxPlayerHealth = 100;
                        damageCooldown = false;
                        setupGame();
                        startTimer();
                        document.getElementById('playerHealthBar').style.display = "block";
                        updateHealthBar();
                        laserPatternInterval = setInterval(spawnLaserPatterns, 2000);
                        setTimeout(() => { spawnRedCubesWave6(); }, 1000);
                        gameOver = false;
                        animate();
                    }, 2000);
                }
            }
        }
        function checkBossBulletsCollision() {
            for (let i = 0; i < bossBullets.length; i++) {
                let b = bossBullets[i];
                if (
                    whiteCube.x < b.x + b.size &&
                    whiteCube.x + cubeSize > b.x &&
                    whiteCube.y < b.y + b.size &&
                    whiteCube.y + cubeSize > b.y
                ) {
                    if (wave >= 6 && wave <= 10) {
                        if (!damageCooldown && takeDamage(20)) {
                            loseLife();
                        }
                    } else {
                        loseLife();
                    }
                    if (gameOver) return;
                }
            }
        }

        // --- Main Animate ---
        function animate() {
            ctx.save();
            ctx.translate(screenShake.x, screenShake.y);
            ctx.clearRect(-screenShake.x, -screenShake.y, width + Math.abs(screenShake.x) * 2, height + Math.abs(screenShake.y) * 2);
            
            moveWhiteCube();
            
            // Red cubes for waves 1, 2, 6, 8, 9
            if (wave < 3 || wave === 6 || wave === 8 || wave === 9) {
                moveRedCubes();
                for (let cube of redCubes) drawCube(cube);
            }
            
            drawCube(whiteCube);
            
            if (wave >= 2) drawLaserPatterns();
            
            // Bullet rain for waves 7, 9
            if (wave === 7 || wave === 9 || wave === 10) {
                moveBulletRain();
                drawBulletRain();
                checkBulletRainCollision();
            }
            
            // Earthquake for waves 8, 9
            if (wave === 8 || wave === 9 || wave === 10) {
                drawEarthquake();
            }
            
            if (upgrades.dash) {
                eUI.style.display = "block";
                eUI.style.left = (canvas.offsetLeft + whiteCube.x + cubeSize + 12) + "px";
                eUI.style.top = (canvas.offsetTop + whiteCube.y + cubeSize / 2 - 16) + "px";
            } else {
                eUI.style.display = "none";
            }
            
            // Collision checks
            if (wave >= 6 && wave <= 10) {
                // Health bar system for waves 6-10
                if (checkCollision() && !damageCooldown) {
                    if (takeDamage(20)) {
                        loseLife();
                        if (gameOver) return;
                    }
                }
            } else if ((wave < 3) && checkCollision()) {
                // Old lives system for waves 1-2
                loseLife();
                if (gameOver) return;
            }
            
            // Wave 4 Boss logic
            if (wave === 4 && bossActive) {
                moveBoss();
                drawBoss();
                drawBossBullets();
                moveBossBullets();
                drawBossGreenCube();
                checkBossGreenCubeCollision();
                checkBossBulletsCollision();
            }
            
            // Wave 10 Final Boss logic
            if (wave === 10 && finalBossActive) {
                moveFinalBoss();
                drawFinalBoss();
                drawBossBullets();
                moveBossBullets();
                drawBossGreenCube();
                drawHealingCubes();
                checkFinalBossGreenCubeCollision();
                checkHealingCubeCollision();
                checkBossBulletsCollision();
            }
            
            ctx.restore();
            
            if (!gameOver) {
                requestAnimationFrame(animate);
            }
        }

        // --- Boss Movement ---
        function moveBoss() {
            if (!boss) return;
            boss.x += bossMoveDir * bossMoveSpeed;
            if (boss.x <= 0) {
                boss.x = 0;
                bossMoveDir = 1;
            }
            if (boss.x + boss.size >= width) {
                boss.x = width - boss.size;
                bossMoveDir = -1;
            }
        }

        // --- Wave Progression ---
        function nextWaveOrGameOver() {
            if (wave === 1) {
                // Pause and show upgrades for wave 2 (choose ONE)
                gameOver = true;
                document.getElementById('upgradeTitle').textContent = "Choose an Upgrade!";
                document.getElementById('upgradeButtons').innerHTML = `
                    <button class="upgrade-btn" onclick="chooseUpgrade('speed10')">10% More Speed</button>
                    <button class="upgrade-btn" onclick="chooseUpgrade('life2')">2 Extra Lives</button>
                    <button class="upgrade-btn" onclick="chooseUpgrade('dash')">Dash Ability</button>
                `;
                document.getElementById('upgradeContainer').style.display = "block";
            } else if (wave === 2) {
                // Pause and show upgrades for wave 3 (choose ONE)
                gameOver = true;
                document.getElementById('upgradeTitle').textContent = "Choose a Wave 3 Upgrade!";
                document.getElementById('upgradeButtons').innerHTML = `
                    <button class="upgrade-btn" onclick="chooseUpgrade('speed20')">20% More Speed</button>
                    <button class="upgrade-btn" onclick="chooseUpgrade('life2')">2 Extra Lives</button>
                `;
                document.getElementById('upgradeContainer').style.display = "block";
            } else if (wave === 3) {
                wave = 4;
                setupGame();
                startBossWave();
                animate();
            } else if (wave === 6) {
                // Continue to wave 7
                wave = 7;
                setupGame();
                startTimer();
                document.getElementById('playerHealthBar').style.display = "block";
                updateHealthBar();
                bulletRainInterval = setInterval(spawnBulletRain, 1500);
                laserPatternInterval = setInterval(spawnLaserPatterns, 1000);
                gameOver = false;
                animate();
            } else if (wave === 7) {
                // Continue to wave 8
                wave = 8;
                setupGame();
                startTimer();
                document.getElementById('playerHealthBar').style.display = "block";
                updateHealthBar();
                earthquakeInterval = setInterval(triggerEarthquake, 3000);
                setTimeout(() => { spawnRedCubesWave8(); }, 500);
                gameOver = false;
                animate();
            } else if (wave === 8) {
                // Continue to wave 9
                wave = 9;
                setupGame();
                startTimer();
                document.getElementById('playerHealthBar').style.display = "block";
                updateHealthBar();
                laserPatternInterval = setInterval(spawnLaserPatterns, 600);
                bulletRainInterval = setInterval(spawnBulletRain, 1000);
                earthquakeInterval = setInterval(triggerEarthquake, 4000);
                setTimeout(() => { spawnRedCubesWave9(); }, 500);
                gameOver = false;
                animate();
            } else if (wave === 9) {
                // Final boss wave 10
                wave = 10;
                setupGame();
                startFinalBoss();
                animate();
            } else {
                document.getElementById('timer').textContent = "Game Over";
                document.getElementById('restartBtn').style.display = "block";
                if (laserPatternInterval) clearInterval(laserPatternInterval);
                if (bulletRainInterval) clearInterval(bulletRainInterval);
                if (earthquakeInterval) clearInterval(earthquakeInterval);
            }
        }

        window.chooseUpgrade = function(type) {
            if (wave === 1) {
                // Wave 1 upgrades
                if (type === "speed10") upgrades.speed = (upgrades.speed || 1) * 1.1;
                if (type === "life2") lives += 2;
                if (type === "dash") upgrades.dash = true;
                wave++;
                setupGame();
                // Remove "Wave One" heading and show "Wave 2" at top center with same style
                document.getElementById('waveTitle').style.display = "none";
                let wave2Title = document.getElementById('wave2Title');
                if (!wave2Title) {
                    wave2Title = document.createElement("h1");
                    wave2Title.id = "wave2Title";
                    wave2Title.style.position = "absolute";
                    wave2Title.style.top = "30px";
                    wave2Title.style.left = "50%";
                    wave2Title.style.transform = "translateX(-50%)";
                    wave2Title.style.color = "#fff";
                    wave2Title.style.fontSize = "48px";
                    wave2Title.style.fontFamily = "Arial, Helvetica, sans-serif";
                    wave2Title.style.zIndex = "2";
                    wave2Title.style.textShadow = "0 0 10px #f00, 0 0 20px #fff";
                    wave2Title.style.pointerEvents = "none";
                    wave2Title.textContent = "Wave 2";
                    document.body.appendChild(wave2Title);
                } else {
                    wave2Title.style.display = "block";
                }
                setTimeout(() => {
                    wave2Title.style.display = "none";
                }, 2000);
                startTimer();
                laserPatternInterval = setInterval(spawnLaserPatterns, 5000);
                gameOver = false;
                animate();
            } else if (wave === 2) {
                // Wave 2 upgrades
                if (type === "speed20") upgrades.speed = (upgrades.speed || 1) * 1.2;
                if (type === "life2") lives += 2;
                wave++;
                setupGame();
                // Show "Wave 2" at top center for wave 3 round
                let wave2Title = document.getElementById('wave2Title');
                if (!wave2Title) {
                    wave2Title = document.createElement("h1");
                    wave2Title.id = "wave2Title";
                    wave2Title.style.position = "absolute";
                    wave2Title.style.top = "30px";
                    wave2Title.style.left = "50%";
                    wave2Title.style.transform = "translateX(-50%)";
                    wave2Title.style.color = "#fff";
                    wave2Title.style.fontSize = "48px";
                    wave2Title.style.fontFamily = "Arial, Helvetica, sans-serif";
                    wave2Title.style.zIndex = "2";
                    wave2Title.style.textShadow = "0 0 10px #f00, 0 0 20px #fff";
                    wave2Title.style.pointerEvents = "none";
                    wave2Title.textContent = "Wave 2";
                    document.body.appendChild(wave2Title);
                } else {
                    wave2Title.style.display = "block";
                }
                setTimeout(() => {
                    wave2Title.style.display = "none";
                }, 2000);
                startTimer();
                laserPatternInterval = setInterval(spawnLaserPatterns, 1200);
                gameOver = false;
                animate();
            }
        };

        function loseLife() {
            // God mode check
            if (godMode && isAdmin) {
                showCheatNotification("🛡️ God Mode protected you!");
                return;
            }
            
            // For waves 6-10, health is already managed by takeDamage
            if (wave >= 6 && wave <= 10) {
                // Reset health for next life
                if (wave === 10) {
                    playerHealth = 250;
                    maxPlayerHealth = 250;
                } else {
                    playerHealth = 100;
                    maxPlayerHealth = 100;
                }
                damageCooldown = false;
                updateHealthBar();
                whiteCube.x = width / 2 - cubeSize / 2;
                whiteCube.y = height / 2 - cubeSize / 2;
                gameOver = true;
                document.getElementById('timer').textContent = "Game Over";
                document.getElementById('restartBtn').style.display = "block";
                clearInterval(timerInterval);
                if (laserPatternInterval) clearInterval(laserPatternInterval);
                if (bulletRainInterval) clearInterval(bulletRainInterval);
                if (earthquakeInterval) clearInterval(earthquakeInterval);
                return;
            }
            
            // Old lives system for waves 1-4
            if (lives > 1) {
                lives--;
                updateLivesDisplay();
                whiteCube.x = width / 2 - cubeSize / 2;
                whiteCube.y = height / 2 - cubeSize / 2;
            } else {
                gameOver = true;
                document.getElementById('timer').textContent = "Game Over";
                document.getElementById('restartBtn').style.display = "block";
                clearInterval(timerInterval);

                // Show correct heading for wave 2 game over
                if (wave === 2) {
                    document.getElementById('waveTitle').style.display = "none";
                    let wave2Title = document.getElementById('wave2Title');
                    if (!wave2Title) {
                        wave2Title = document.createElement("h1");
                        wave2Title.id = "wave2Title";
                        wave2Title.style.position = "absolute";
                        wave2Title.style.top = "30px";
                        wave2Title.style.left = "50%";
                        wave2Title.style.transform = "translateX(-50%)";
                        wave2Title.style.color = "#fff";
                        wave2Title.style.fontSize = "48px";
                        wave2Title.style.fontFamily = "Arial, Helvetica, sans-serif";
                        wave2Title.style.zIndex = "2";
                        wave2Title.style.textShadow = "0 0 10px #f00, 0 0 20px #fff";
                        wave2Title.style.pointerEvents = "none";
                        wave2Title.textContent = "Wave 2";
                        document.body.appendChild(wave2Title);
                    } else {
                        wave2Title.style.display = "block";
                    }
                }
            }
        }
        function restartGame() {
            // Do NOT reset upgrades or wave, just reset lives and restart current wave
            lives = upgrades.life ? 2 : 1;
            if (wave === 3 && moreSpeed) lives += 0;
            if (wave === 3 && furtherDash) lives += 0;
            if (wave === 3 && typeof extraLives !== "undefined" && extraLives) lives += 2;
            if (wave === 4 && moreSpeed) lives += 0;
            if (wave === 4 && furtherDash) lives += 0;
            
            // Reset health for waves 6-10
            if (wave >= 6 && wave <= 9) {
                playerHealth = 100;
                maxPlayerHealth = 100;
                damageCooldown = false;
            } else if (wave === 10) {
                playerHealth = 250;
                maxPlayerHealth = 250;
                damageCooldown = false;
            }
            
            setupGame();
            if (wave === 2) laserPatternInterval = setInterval(spawnLaserPatterns, 5000);
            if (wave === 3) laserPatternInterval = setInterval(spawnLaserPatterns, 1200);
            if (wave === 4) startBossWave();
            if (wave === 6) {
                document.getElementById('playerHealthBar').style.display = "block";
                updateHealthBar();
                laserPatternInterval = setInterval(spawnLaserPatterns, 2000);
                setTimeout(() => { spawnRedCubesWave6(); }, 1000);
            }
            if (wave === 7) {
                document.getElementById('playerHealthBar').style.display = "block";
                updateHealthBar();
                bulletRainInterval = setInterval(spawnBulletRain, 1500);
                laserPatternInterval = setInterval(spawnLaserPatterns, 1000);
            }
            if (wave === 8) {
                document.getElementById('playerHealthBar').style.display = "block";
                updateHealthBar();
                earthquakeInterval = setInterval(triggerEarthquake, 3000);
                setTimeout(() => { spawnRedCubesWave8(); }, 500);
            }
            if (wave === 9) {
                document.getElementById('playerHealthBar').style.display = "block";
                updateHealthBar();
                laserPatternInterval = setInterval(spawnLaserPatterns, 600);
                bulletRainInterval = setInterval(spawnBulletRain, 1000);
                earthquakeInterval = setInterval(triggerEarthquake, 4000);
                setTimeout(() => { spawnRedCubesWave9(); }, 500);
            }
            if (wave === 10) startFinalBoss();
            startTimer();
            animate();
        }

        // --- Responsive ---
        window.addEventListener('resize', () => {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        });

        // --- Boss Movement ---
        function moveBoss() {
            if (!boss) return;
            boss.x += bossMoveDir * bossMoveSpeed;
            if (boss.x <= 0) {
                boss.x = 0;
                bossMoveDir = 1;
            }
            if (boss.x + boss.size >= width) {
                boss.x = width - boss.size;
                bossMoveDir = -1;
            }
        }

        // --- Wave 6-10 Functions ---
        function spawnRedCubesWave6() {
            for (let i = 0; i < 4; i++) {
                let pos = randomEdgePosition();
                redCubes.push({
                    x: pos.x,
                    y: pos.y,
                    color: "#f00",
                    speed: 4.5 + Math.random(),
                    size: 40
                });
            }
        }
        
        function spawnRedCubesWave8() {
            for (let i = 0; i < 5; i++) {
                let pos = randomEdgePosition();
                redCubes.push({
                    x: pos.x,
                    y: pos.y,
                    color: "#f00",
                    speed: 5 + Math.random(),
                    size: 35
                });
            }
        }
        
        function spawnRedCubesWave9() {
            for (let i = 0; i < 8; i++) {
                let pos = randomEdgePosition();
                redCubes.push({
                    x: pos.x,
                    y: pos.y,
                    color: "#f00",
                    speed: 5.5 + Math.random(),
                    size: 30
                });
            }
        }
        
        function spawnBulletRain() {
            for (let i = 0; i < 8; i++) {
                bulletRain.push({
                    x: Math.random() * width,
                    y: -20,
                    size: 15,
                    color: "#ff0",
                    speed: 8 + Math.random() * 3
                });
            }
        }
        
        function moveBulletRain() {
            let speedMultiplier = (slowMotionActive && isAdmin) ? 0.3 : 1;
            for (let i = 0; i < bulletRain.length; i++) {
                bulletRain[i].y += bulletRain[i].speed * speedMultiplier;
            }
            bulletRain = bulletRain.filter(b => b.y < height + 50);
        }
        
        function drawBulletRain() {
            for (let b of bulletRain) {
                ctx.save();
                ctx.fillStyle = b.color;
                ctx.shadowColor = "#ff0";
                ctx.shadowBlur = 15;
                ctx.fillRect(b.x, b.y, b.size, b.size);
                ctx.restore();
            }
        }
        
        function checkBulletRainCollision() {
            for (let b of bulletRain) {
                if (
                    whiteCube.x < b.x + b.size &&
                    whiteCube.x + cubeSize > b.x &&
                    whiteCube.y < b.y + b.size &&
                    whiteCube.y + cubeSize > b.y
                ) {
                    if (wave >= 6 && wave <= 10) {
                        if (!damageCooldown && takeDamage(20)) {
                            loseLife();
                        }
                    } else {
                        loseLife();
                    }
                    return;
                }
            }
        }
        
        function triggerEarthquake() {
            earthquakeActive = true;
            earthquakeZones = [];
            // Create 3-5 danger zones on the ground
            let zoneCount = Math.floor(Math.random() * 3) + 3;
            for (let i = 0; i < zoneCount; i++) {
                earthquakeZones.push({
                    x: Math.random() * (width - 150),
                    y: height - 100,
                    width: 150,
                    height: 100,
                    warning: true
                });
            }
            // Warning phase
            setTimeout(() => {
                for (let zone of earthquakeZones) {
                    zone.warning = false;
                }
                // Check damage after 500ms
                setTimeout(() => {
                    checkEarthquakeDamage();
                    earthquakeActive = false;
                    earthquakeZones = [];
                }, 500);
            }, 1000);
        }
        
        function drawEarthquake() {
            if (earthquakeActive) {
                // Screen shake effect
                screenShake.x = (Math.random() - 0.5) * 10;
                screenShake.y = (Math.random() - 0.5) * 10;
                
                for (let zone of earthquakeZones) {
                    ctx.save();
                    if (zone.warning) {
                        ctx.fillStyle = "rgba(255, 165, 0, 0.4)";
                        ctx.strokeStyle = "#ffa500";
                    } else {
                        ctx.fillStyle = "rgba(255, 0, 0, 0.6)";
                        ctx.strokeStyle = "#f00";
                    }
                    ctx.lineWidth = 3;
                    ctx.fillRect(zone.x, zone.y, zone.width, zone.height);
                    ctx.strokeRect(zone.x, zone.y, zone.width, zone.height);
                    ctx.restore();
                }
            } else {
                screenShake.x = 0;
                screenShake.y = 0;
            }
        }
        
        function checkEarthquakeDamage() {
            for (let zone of earthquakeZones) {
                if (!zone.warning &&
                    whiteCube.x < zone.x + zone.width &&
                    whiteCube.x + cubeSize > zone.x &&
                    whiteCube.y < zone.y + zone.height &&
                    whiteCube.y + cubeSize > zone.y
                ) {
                    if (wave >= 6 && wave <= 10) {
                        if (!damageCooldown && takeDamage(20)) {
                            loseLife();
                        }
                    } else {
                        loseLife();
                    }
                    return;
                }
            }
        }
        
        function startFinalBoss() {
            finalBossActive = true;
            finalBossHealth = 1000; // Boss has 1000 HP
            playerHealth = 250;
            maxPlayerHealth = 250;
            damageCooldown = false;
            document.getElementById('bossHealthBar').style.display = "block";
            document.getElementById('bossHealthValue').textContent = finalBossHealth;
            document.getElementById('playerHealthBar').style.display = "block";
            updateHealthBar();
            document.getElementById('timer').textContent = "FINAL BOSS";
            if (timerInterval) clearInterval(timerInterval);
            
            finalBoss = { x: width / 2 - 150, y: 50, size: 300, color: "#f0f" };
            bossBullets = [];
            bossGreenCube = null;
            bossGreenCubeActive = false;
            healingCubes = [];
            
            // Final boss shoots faster and has all mechanics
            bossBulletInterval = setInterval(() => { shootFinalBossBullets(); }, 800);
            laserPatternInterval = setInterval(spawnLaserPatterns, 900);
            bulletRainInterval = setInterval(spawnBulletRain, 1200);
            earthquakeInterval = setInterval(triggerEarthquake, 5000);
            bossGreenCubeTimeout = setInterval(() => { spawnBossGreenCube(); }, 3000); // Every 3 seconds
            healingCubeInterval = setInterval(() => { spawnHealingCube(); }, 2000); // Every 2 seconds
        }
        
        function shootFinalBossBullets() {
            if (!finalBossActive) return;
            let centerX = finalBoss.x + finalBoss.size / 2;
            let centerY = finalBoss.y + finalBoss.size / 2;
            // Spiral pattern
            for (let i = 0; i < 20; i++) {
                let angle = (2 * Math.PI / 20) * i;
                bossBullets.push({
                    x: centerX,
                    y: centerY,
                    size: 20,
                    color: "#0ff",
                    dx: Math.cos(angle) * 8,
                    dy: Math.sin(angle) * 8
                });
            }
        }
        
        function drawFinalBoss() {
            if (!finalBossActive || !finalBoss) return;
            ctx.save();
            ctx.fillStyle = finalBoss.color;
            ctx.shadowColor = "#f0f";
            ctx.shadowBlur = 40;
            ctx.fillRect(finalBoss.x, finalBoss.y, finalBoss.size, finalBoss.size);
            // Add pulsing effect
            let pulseSize = Math.sin(Date.now() / 200) * 10;
            ctx.strokeStyle = "#fff";
            ctx.lineWidth = 5;
            ctx.strokeRect(finalBoss.x - pulseSize/2, finalBoss.y - pulseSize/2, 
                finalBoss.size + pulseSize, finalBoss.size + pulseSize);
            ctx.restore();
        }
        
        function moveFinalBoss() {
            if (!finalBoss) return;
            finalBoss.x += bossMoveDir * 6;
            if (finalBoss.x <= 0) {
                finalBoss.x = 0;
                bossMoveDir = 1;
            }
            if (finalBoss.x + finalBoss.size >= width) {
                finalBoss.x = width - finalBoss.size;
                bossMoveDir = -1;
            }
        }
        
        function checkFinalBossGreenCubeCollision() {
            if (!bossGreenCubeActive || !bossGreenCube) return;
            if (
                whiteCube.x < bossGreenCube.x + bossGreenCube.size &&
                whiteCube.x + cubeSize > bossGreenCube.x &&
                whiteCube.y < bossGreenCube.y + bossGreenCube.size &&
                whiteCube.y + cubeSize > bossGreenCube.y
            ) {
                finalBossHealth -= 80; // Each white block does 80 damage
                if (finalBossHealth < 0) finalBossHealth = 0;
                document.getElementById('bossHealthValue').textContent = finalBossHealth;
                bossGreenCubeActive = false;
                bossGreenCube = null;
                // Green cubes now spawn automatically every 3 seconds via interval
                
                if (finalBossHealth <= 0) {
                    finalBossActive = false;
                    gameOver = true;
                    document.getElementById('bossHealthBar').style.display = "none";
                    document.getElementById('timer').textContent = "YOU WIN! GAME COMPLETE!";
                    clearInterval(bossBulletInterval);
                    clearInterval(laserPatternInterval);
                    clearInterval(bulletRainInterval);
                    clearInterval(earthquakeInterval);
                    if (bossGreenCubeTimeout) clearInterval(bossGreenCubeTimeout); // Changed from clearTimeout
                    if (healingCubeInterval) clearInterval(healingCubeInterval);
                    setTimeout(() => {
                        document.getElementById('restartBtn').style.display = "block";
                    }, 1500);
                }
            }
        }
        
        // Healing cube functions
        function spawnHealingCube() {
            if (!finalBossActive) return;
            let edge = Math.floor(Math.random() * 4);
            let x, y;
            let size = 40;
            if (edge === 0) { x = 0; y = Math.random() * (height - size); }
            else if (edge === 1) { x = width - size; y = Math.random() * (height - size); }
            else if (edge === 2) { x = Math.random() * (width - size); y = 0; }
            else { x = Math.random() * (width - size); y = height - size; }
            healingCubes.push({ x, y, size, color: "#fff", active: true });
        }
        
        function drawHealingCubes() {
            for (let cube of healingCubes) {
                if (cube.active) {
                    ctx.save();
                    ctx.fillStyle = cube.color;
                    ctx.shadowColor = "#fff";
                    ctx.shadowBlur = 25;
                    ctx.fillRect(cube.x, cube.y, cube.size, cube.size);
                    // Add white cross/plus symbol for healing
                    ctx.fillStyle = "#0f0";
                    ctx.fillRect(cube.x + 15, cube.y + 8, 10, 24);
                    ctx.fillRect(cube.x + 8, cube.y + 15, 24, 10);
                    ctx.restore();
                }
            }
        }
        
        function checkHealingCubeCollision() {
            for (let i = 0; i < healingCubes.length; i++) {
                let cube = healingCubes[i];
                if (!cube.active) continue;
                
                if (
                    whiteCube.x < cube.x + cube.size &&
                    whiteCube.x + cubeSize > cube.x &&
                    whiteCube.y < cube.y + cube.size &&
                    whiteCube.y + cubeSize > cube.y
                ) {
                    // Heal player by 20 HP
                    playerHealth += 20;
                    if (playerHealth > maxPlayerHealth) playerHealth = maxPlayerHealth;
                    updateHealthBar();
                    cube.active = false;
                    healingCubes.splice(i, 1);
                    i--;
                    
                    // Show heal notification
                    showHealNotification();
                }
            }
        }
        
        function showHealNotification() {
            let notification = document.createElement('div');
            notification.textContent = "+20 HP";
            notification.style.position = 'absolute';
            notification.style.left = '50%';
            notification.style.top = '40%';
            notification.style.transform = 'translate(-50%, -50%)';
            notification.style.background = 'rgba(0, 255, 0, 0.9)';
            notification.style.color = '#fff';
            notification.style.padding = '15px 30px';
            notification.style.borderRadius = '10px';
            notification.style.fontSize = '32px';
            notification.style.fontFamily = 'Arial, Helvetica, sans-serif';
            notification.style.fontWeight = 'bold';
            notification.style.zIndex = '1000';
            notification.style.boxShadow = '0 0 30px #0f0';
            notification.style.border = '3px solid #fff';
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 800);
        }

        // --- Mobile Controls Initialization ---
        function initMobileControls() {
            const mobileControls = document.getElementById('mobileControls');
            const joystick = document.getElementById('mobileJoystick');
            const knob = document.getElementById('joystickKnob');
            const dashBtn = document.getElementById('mobileDashBtn');
            
            mobileControls.style.display = 'block';
            
            // Joystick touch handling
            let joystickTouch = null;
            const joystickRect = joystick.getBoundingClientRect();
            const joystickCenterX = joystickRect.width / 2;
            const joystickCenterY = joystickRect.height / 2;
            const joystickRadius = joystickRect.width / 2;
            
            joystick.addEventListener('touchstart', (e) => {
                e.preventDefault();
                joystickTouch = e.touches[0];
                mobileJoystick.active = true;
                updateJoystick(e.touches[0]);
            });
            
            joystick.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (mobileJoystick.active) {
                    updateJoystick(e.touches[0]);
                }
            });
            
            joystick.addEventListener('touchend', (e) => {
                e.preventDefault();
                mobileJoystick.active = false;
                mobileJoystick.deltaX = 0;
                mobileJoystick.deltaY = 0;
                knob.style.transform = 'translate(-50%, -50%)';
            });
            
            function updateJoystick(touch) {
                const rect = joystick.getBoundingClientRect();
                const touchX = touch.clientX - rect.left;
                const touchY = touch.clientY - rect.top;
                
                let deltaX = touchX - joystickCenterX;
                let deltaY = touchY - joystickCenterY;
                
                // Limit to joystick radius
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const maxDistance = joystickRadius - 30;
                
                if (distance > maxDistance) {
                    deltaX = (deltaX / distance) * maxDistance;
                    deltaY = (deltaY / distance) * maxDistance;
                }
                
                // Update knob position
                knob.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;
                
                // Normalize for movement (-1 to 1)
                mobileJoystick.deltaX = deltaX / maxDistance;
                mobileJoystick.deltaY = deltaY / maxDistance;
            }
            
            // Dash button handling
            dashBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (mobileDashReady) {
                    performDash();
                }
            });
            
            // Hide dash button initially if no dash upgrade
            if (!upgrades.dash) {
                dashBtn.style.display = 'none';
            }
        }
        
        // Update dash button visibility when upgrade is acquired
        const originalChooseUpgrade = window.chooseUpgrade;
        window.chooseUpgrade = function(type) {
            originalChooseUpgrade(type);
            if (isMobile && type === 'dash' && upgrades.dash) {
                document.getElementById('mobileDashBtn').style.display = 'flex';
            }
        };

        // --- Start ---
        // Game will start after login
        // setupGame();
        // startTimer();
        // animate();
        
        // Play page transition sound on load
        window.addEventListener('DOMContentLoaded', () => {
            playPageTransitionSound();
        });
        
        function playPageTransitionSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const now = audioContext.currentTime;
            
            // Create a pleasant chord progression for page transition
            const notes = [
                { freq: 523.25, start: 0, duration: 0.8 },      // C5
                { freq: 659.25, start: 0.3, duration: 0.8 },    // E5
                { freq: 783.99, start: 0.6, duration: 1.4 },    // G5
                { freq: 1046.50, start: 0.9, duration: 1.1 }    // C6
            ];
            
            notes.forEach(note => {
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                
                osc.connect(gain);
                gain.connect(audioContext.destination);
                
                osc.frequency.value = note.freq;
                osc.type = 'sine';
                
                const startTime = now + note.start;
                const endTime = startTime + note.duration;
                
                gain.gain.setValueAtTime(0, startTime);
                gain.gain.linearRampToValueAtTime(0.15, startTime + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, endTime);
                
                osc.start(startTime);
                osc.stop(endTime);
            });
        }
    </script>

    
</body>
</html>